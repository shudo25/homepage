<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>åŒæœŸç”Ÿæƒ…å ± - ä¿®é“25å›</title>
  <link rel="stylesheet" href="../common/responsive.css">
  <style>
    body {
      background-color: #fafafa;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c5aa0;
      border-bottom: 3px solid #4169e1;
      padding-bottom: 15px;
      margin-bottom: 30px;
    }
    .section {
      background-color: #f9f9f9;
      padding: 25px;
      margin: 20px 0;
      border-radius: 8px;
      border-left: 5px solid #4169e1;
    }
    .section h2 {
      color: #2c5aa0;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 22px;
    }
    .section p {
      color: #555;
      line-height: 1.8;
      margin-bottom: 15px;
    }
    .download-btn {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 30px;
      text-decoration: none;
      border-radius: 5px;
      font-weight: 600;
      transition: transform 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .view-btn {
      display: inline-block;
      background: white;
      color: #667eea;
      padding: 12px 30px;
      text-decoration: none;
      border-radius: 5px;
      border: 2px solid #667eea;
      font-weight: 600;
      transition: all 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .view-btn:hover {
      background: #667eea;
      color: white;
    }
    .notice {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      color: #856404;
    }
    .notice strong {
      display: block;
      margin-bottom: 8px;
    }
    .logout-btn {
      float: right;
      background: #dc143c;
      color: white;
      padding: 8px 20px;
      text-decoration: none;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .logout-btn:hover {
      background: #b00020;
    }
    .back-link {
      margin-top: 30px;
      text-align: center;
    }
    .back-link a {
      color: #667eea;
      text-decoration: none;
    }
    .back-link a:hover {
      text-decoration: underline;
    }
    .coming-soon {
      color: #999;
      font-style: italic;
    }
    .photo-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s;
      cursor: pointer;
    }
    .photo-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }
    .photo-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .photo-card .photo-info {
      padding: 10px;
      text-align: center;
      color: #555;
      font-size: 14px;
    }
    .loading-spinner {
      text-align: center;
      padding: 30px;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <h1>ğŸ“š åŒæœŸç”Ÿæƒ…å ±</h1>
    
    <div class="notice">
      <strong>âš ï¸ å€‹äººæƒ…å ±ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦</strong>
      ã“ã®ãƒšãƒ¼ã‚¸ã®æƒ…å ±ã¯åŒæœŸç”Ÿå°‚ç”¨ã§ã™ã€‚ç¬¬ä¸‰è€…ã¸ã®å…±æœ‰ã‚„è»¢è¼‰ã¯ã”é æ…®ãã ã•ã„ã€‚
    </div>
    
    <div class="section">
      <h2>ğŸ“‹ åç°¿</h2>
      <p>
        ä¿®é“25å›ç”Ÿã®æœ€æ–°åç°¿ã§ã™ã€‚é€£çµ¡å…ˆã‚„ä½æ‰€ãªã©ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚<br>
        æƒ…å ±ã«å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ã€é‹å–¶å§”å“¡ä¼šã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚
      </p>
      <div id="memberList">
        <button class="view-btn" onclick="viewPDF('meibo')">ğŸ“„ ãƒ–ãƒ©ã‚¦ã‚¶ã§é–²è¦§</button>
        <a href="#" class="download-btn" onclick="downloadPDF('meibo'); return false;">â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
      </div>
    </div>
    
    <div class="section">
      <h2>ğŸ“· å†™çœŸé›†</h2>
      <p>
        åŒæœŸä¼šã‚„ã‚¤ãƒ™ãƒ³ãƒˆã§ã®å†™çœŸã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚<br>
        æ€ã„å‡ºã®ä¸€æšã‚’æ¢ã—ã¦ã¿ã¦ãã ã•ã„ã€‚<br>
        <small style="color: #999;">â€» ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ‹¡å¤§è¡¨ç¤ºã•ã‚Œã¾ã™</small>
      </p>
      <div id="photoGallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
        <!-- å†™çœŸãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
      </div>
    </div>
    
    <!-- ç”»åƒæ‹¡å¤§è¡¨ç¤ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; cursor: pointer;" onclick="closeModal()">
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%;">
        <img id="modalImage" style="max-width: 100%; max-height: 90vh; display: block;">
        <p id="modalTitle" style="color: white; text-align: center; margin-top: 15px; font-size: 18px;"></p>
      </div>
      <button onclick="closeModal(); event.stopPropagation();" style="position: absolute; top: 20px; right: 30px; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">Ã—</button>
    </div>
    
    <div class="back-link">
      <a href="../index.html">â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
    </div>
  </div>

  <script>
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    window.addEventListener('DOMContentLoaded', () => {
      if (sessionStorage.getItem('groupinfo_auth') !== 'authenticated') {
        window.location.href = 'index.html';
      }
    });
    
    function logout() {
      sessionStorage.removeItem('groupinfo_auth');
      sessionStorage.removeItem('groupinfo_key');
      window.location.href = 'index.html';
    }
    
    // æš—å·åŒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const fileMapping = {
      'meibo': {
        encrypted: 'd8f3a7c9b5e2f1a4d6c8b9e7f3a5c2d1.enc',
        filename: 'é–¢æ±ä¿®é“ï¼’ï¼•å›åç°¿.pdf'
      }
    };
    
    // å†™çœŸã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆãƒ‡ãƒ¢ç”¨ï¼šåŒã˜å†™çœŸã‚’è¤‡æ•°è¡¨ç¤ºï¼‰
    const photoMapping = [
      { id: 1, encrypted: 'photos/p001.enc', title: '2025å¹´11æœˆ åŒæœŸä¼š', description: 'éº»å¸ƒåç•ªã§ã®é›†ã¾ã‚Š' },
      { id: 2, encrypted: 'photos/p001.enc', title: '2025å¹´10æœˆ ç«¶é¦¬ã‚’æ¥½ã—ã‚€ä¼š', description: 'ç§‹ã®ç«¶é¦¬å ´ã«ã¦' },
      { id: 3, encrypted: 'photos/p001.enc', title: '2024å¹´ æ–°å¹´ä¼š', description: 'æ–°å¹´ã®é›†ã„' },
      { id: 4, encrypted: 'photos/p001.enc', title: '2024å¹´ ç§‹ã®åŒæœŸä¼š', description: 'æ‡ã‹ã—ã„é¡”ã¶ã‚Œ' },
      { id: 5, encrypted: 'photos/p001.enc', title: '2023å¹´ å¿˜å¹´ä¼š', description: 'å¹´æœ«ã®é›†ã¾ã‚Š' },
      { id: 6, encrypted: 'photos/p001.enc', title: '2023å¹´ å¤ã®ä¼š', description: 'ãƒ“ã‚¢ã‚¬ãƒ¼ãƒ‡ãƒ³ã«ã¦' },
      { id: 7, encrypted: 'photos/p001.enc', title: '2022å¹´ æ–°æ˜¥ã®ä¼š', description: 'æ–°å¹´ã®æŠ±è² ã‚’èªã‚Šåˆã†' },
      { id: 8, encrypted: 'photos/p001.enc', title: '2022å¹´ ç§‹ã®æ—…è¡Œ', description: 'æ¸©æ³‰æ—…è¡Œã®æ€ã„å‡º' }
      // å®Ÿéš›ã®å†™çœŸãŒå¢—ãˆãŸã‚‰ã€encrypted ã®ãƒ‘ã‚¹ã‚’å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´
    ];
    
    // XORå¾©å·åŒ–é–¢æ•°
    function xorDecrypt(encryptedData, key) {
      const keyBytes = new TextEncoder().encode(key);
      const keyLen = keyBytes.length;
      const decrypted = new Uint8Array(encryptedData.length);
      
      for (let i = 0; i < encryptedData.length; i++) {
        decrypted[i] = encryptedData[i] ^ keyBytes[i % keyLen];
      }
      
      return decrypted;
    }
    
    // Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
    function base64ToArrayBuffer(base64) {
      const binaryString = atob(base64);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes;
    }
    
    // PDFã‚’å¾©å·åŒ–ã—ã¦è¡¨ç¤º
    async function viewPDF(type) {
      const fileInfo = fileMapping[type];
      if (!fileInfo) return;
      
      const password = sessionStorage.getItem('groupinfo_key');
      if (!password) {
        alert('èªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
        logout();
        return;
      }
      
      try {
        // æš—å·åŒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        const response = await fetch(fileInfo.encrypted);
        const base64Data = await response.text();
        
        // Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
        const encryptedData = base64ToArrayBuffer(base64Data);
        
        // XORå¾©å·åŒ–
        const decryptedData = xorDecrypt(encryptedData, password);
        
        // Blobã‚’ä½œæˆ
        const blob = new Blob([decryptedData], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        // æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        window.open(url, '_blank');
        
        // ãƒ¡ãƒ¢ãƒªè§£æ”¾ï¼ˆ5ç§’å¾Œï¼‰
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      } catch (error) {
        console.error('PDFã®å¾©å·åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        alert('PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }
    
    // PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    async function downloadPDF(type) {
      const fileInfo = fileMapping[type];
      if (!fileInfo) return;
      
      const password = sessionStorage.getItem('groupinfo_key');
      if (!password) {
        alert('èªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
        logout();
        return;
      }
      
      try {
        // æš—å·åŒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        const response = await fetch(fileInfo.encrypted);
        const base64Data = await response.text();
        
        // Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
        const encryptedData = base64ToArrayBuffer(base64Data);
        
        // XORå¾©å·åŒ–
        const decryptedData = xorDecrypt(encryptedData, password);
        
        // Blobã‚’ä½œæˆ
        const blob = new Blob([decryptedData], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const link = document.createElement('a');
        link.href = url;
        link.download = fileInfo.filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // ãƒ¡ãƒ¢ãƒªè§£æ”¾
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      } catch (error) {
        console.error('PDFã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        alert('PDFã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }
    
    // å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®åˆæœŸåŒ–
    async function initPhotoGallery() {
      const gallery = document.getElementById('photoGallery');
      gallery.innerHTML = '<div class="loading-spinner">ğŸ“· å†™çœŸã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      const password = sessionStorage.getItem('groupinfo_key');
      if (!password) {
        gallery.innerHTML = '<p class="coming-soon">èªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }
      
      gallery.innerHTML = '';
      
      for (const photo of photoMapping) {
        try {
          // æš—å·åŒ–ã•ã‚ŒãŸç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§å¾©å·åŒ–
          const response = await fetch(photo.encrypted);
          if (!response.ok) {
            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
            continue;
          }
          
          const base64Data = await response.text();
          const encryptedData = base64ToArrayBuffer(base64Data);
          const decryptedData = xorDecrypt(encryptedData, password);
          
          // Blobã‚’ä½œæˆã—ã¦ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º
          const blob = new Blob([decryptedData], { type: 'image/jpeg' });
          const url = URL.createObjectURL(blob);
          
          // ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
          const card = document.createElement('div');
          card.className = 'photo-card';
          card.innerHTML = `
            <img src="${url}" alt="${photo.title}">
            <div class="photo-info">
              <strong>${photo.title}</strong><br>
              <small>${photo.description || ''}</small>
            </div>
          `;
          
          // ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§è¡¨ç¤º
          card.onclick = () => showModal(url, photo.title);
          
          gallery.appendChild(card);
        } catch (error) {
          console.log(`å†™çœŸ ${photo.id} ã®èª­ã¿è¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—:`, error);
        }
      }
      
      if (gallery.children.length === 0) {
        gallery.innerHTML = '<p class="coming-soon">å†™çœŸã¯ã¾ã ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
      }
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ç”»åƒã‚’æ‹¡å¤§è¡¨ç¤º
    function showModal(imageUrl, title) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      const modalTitle = document.getElementById('modalTitle');
      
      modalImage.src = imageUrl;
      modalTitle.textContent = title;
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeModal() {
      const modal = document.getElementById('imageModal');
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', () => {
      initPhotoGallery();
    });
  </script>
</body>
</html>
